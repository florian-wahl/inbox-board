import{r as h,j as e,B as i,T as n,n as I,o as B,P as k,p as $,q as z,s as E,t as Y,u as f,v as r,R as v,I as M,K as A,w as F,x as _,y as Z,z as V,E as ee,F as se,G as L}from"./mui-vendor-EY2v0Zuk.js";import{u as ne,a as te}from"./index-omMUvaP9.js";import"./react-vendor-Csw2ODfV.js";import"./dexie-vendor-DmXeiz56.js";import"./utils-vendor-D2KzgrTC.js";import"./router-vendor-fLdkdyln.js";function ae({order:s}){const[a,o]=v.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(f,{sx:{"& > *":{borderBottom:"unset"},cursor:"pointer"},onClick:()=>o(!a),children:[e.jsx(r,{sx:{width:40,p:0},children:e.jsx(M,{"aria-label":"expand row",size:"small",children:a?e.jsx(A,{}):e.jsx(F,{})})}),e.jsx(r,{sx:{border:0,p:1},children:new Date(s.date).toLocaleDateString()}),e.jsx(r,{sx:{border:0,p:1},children:s.merchant}),e.jsx(r,{sx:{border:0,p:1},children:s.amount?`$${s.amount}`:""})]}),e.jsx(f,{children:e.jsx(r,{style:{paddingBottom:0,paddingTop:0},colSpan:4,children:e.jsxs(_,{in:a,timeout:"auto",unmountOnExit:!0,children:[e.jsxs(i,{margin:1,children:[e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"From:"})," ",s.from]}),s.subject&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Subject:"})," ",s.subject]}),s.to&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"To:"})," ",s.to]}),e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Sent:"})," ",new Date(s.date).toLocaleString()]}),s.labelIds&&s.labelIds.length>0&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Labels:"})," ",s.labelIds.join(", ")]}),s.headers&&Array.isArray(s.headers)&&(()=>{const l=s.headers.find(d=>d.name&&d.name.toLowerCase()==="list-unsubscribe");return e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"List-Unsubscribe:"})," ",l?l.value:"None"]})})()]}),s.orderMatchKeyword&&e.jsx(i,{margin:1,children:e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Order Keyword:"})," ",s.orderMatchKeyword]})})]})})})]})}function re({subscription:s}){const[a,o]=v.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(f,{sx:{"& > *":{borderBottom:"unset"},cursor:"pointer"},onClick:()=>o(!a),children:[e.jsx(r,{sx:{width:40,p:0},children:e.jsx(M,{"aria-label":"expand row",size:"small",children:a?e.jsx(A,{}):e.jsx(F,{})})}),e.jsx(r,{sx:{border:0,p:1},children:s.merchant}),e.jsx(r,{sx:{border:0,p:1},children:s.amount?`$${s.amount}`:""})]}),e.jsx(f,{children:e.jsx(r,{style:{paddingBottom:0,paddingTop:0},colSpan:3,children:e.jsx(_,{in:a,timeout:"auto",unmountOnExit:!0,children:e.jsxs(i,{margin:1,children:[e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"From:"})," ",s.from]}),s.to&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"To:"})," ",s.to]}),s.subject&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Subject:"})," ",s.subject]}),s.date&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Sent:"})," ",new Date(s.date).toLocaleString()]}),s.labelIds&&s.labelIds.length>0&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Labels:"})," ",s.labelIds.join(", ")]})]})})})})]})}function K(s){return s?Array.from(s.matchAll(/<([^>]+)>/g)).map(o=>o[1].trim()):[]}function oe(s){const a=new Map,o=new Map;for(const l of s)a.set(l.from,l),o.set(l.from,(o.get(l.from)||0)+1);return Array.from(a.values()).map(l=>({...l,_parsedUnsubUris:K(l.listUnsubscribe||""),_occurrenceCount:o.get(l.from)||1})).sort((l,d)=>d._occurrenceCount-l._occurrenceCount)}function le({sender:s}){const[a,o]=v.useState(!1),[l,d]=v.useState(!1),[x,u]=v.useState(null),[W,g]=v.useState(!1),{enqueueSnackbar:y,closeSnackbar:w}=te(),j=s._parsedUnsubUris||K(s.listUnsubscribe||""),U=async()=>{const S=j.find(b=>b.startsWith("http://")||b.startsWith("https://")),O=j.find(b=>b.startsWith("mailto:"));let m=!1,R="";const D=y(`Unsubscribing from ${s.from}...`,{variant:"info",persist:!0});try{S?(u(S),g(!1),d(!0)):O?m=!0:R="No supported unsubscribe method found."}catch(b){R=b.message||"Unknown error"}finally{w(D),y(m?`Unsubscribe request sent for ${s.from}!`:`Failed to unsubscribe from ${s.from}: ${R}`,{variant:m?"success":"error"})}},C=()=>{d(!1),u(null),g(!1)},P=()=>{g(!0),x&&window.open(x,"_blank"),d(!1),u(null)};return e.jsxs(e.Fragment,{children:[e.jsxs(Z,{open:l,onClose:C,maxWidth:"md",fullWidth:!0,children:[e.jsx(V,{children:"Unsubscribe"}),e.jsx(ee,{sx:{height:600,p:0},children:x&&!W&&e.jsx("iframe",{src:x,title:"Unsubscribe",width:"100%",height:"100%",style:{border:0,minHeight:600},onError:P})}),e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",width:"100%"},children:[e.jsx(i,{children:x&&e.jsx(L,{variant:"outlined",size:"small",onClick:()=>{window.open(x,"_blank")},children:"Open in a new tab"})}),e.jsx(i,{children:e.jsx(L,{onClick:C,children:"Close"})})]})]}),e.jsxs(f,{sx:{"& > *":{borderBottom:"unset"},cursor:"pointer"},onClick:()=>o(!a),children:[e.jsx(r,{sx:{width:40,p:0},children:e.jsx(M,{"aria-label":"expand row",size:"small",children:a?e.jsx(A,{}):e.jsx(F,{})})}),e.jsx(r,{sx:{border:0,p:1,width:"100%"},children:s.from}),e.jsx(r,{sx:{border:0,p:1,whiteSpace:"nowrap"},children:e.jsx(I,{label:s._occurrenceCount,color:"default",size:"small",sx:{verticalAlign:"middle"}})}),e.jsx(r,{sx:{border:0,p:1,whiteSpace:"nowrap"},children:j.length>0&&e.jsx(L,{variant:"contained",color:"primary",size:"small",disabled:s.unsubscribeType!=="http",onClick:S=>{S.stopPropagation(),U()},children:"Unsubscribe"})})]}),e.jsx(f,{children:e.jsx(r,{style:{paddingBottom:0,paddingTop:0},colSpan:4,children:e.jsx(_,{in:a,timeout:"auto",unmountOnExit:!0,children:e.jsxs(i,{margin:1,sx:{wordBreak:"break-word",whiteSpace:"pre-line",maxWidth:"100%"},children:[e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Sender Domain:"})," ",s.domain]}),s.from&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"From:"})," ",s.from]}),s.subject&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Subject:"})," ",s.subject]}),s.to&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"To:"})," ",s.to]}),s.date&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Sent:"})," ",new Date(s.date).toLocaleString()]}),s.labelIds&&s.labelIds.length>0&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Labels:"})," ",s.labelIds.join(", ")]}),s.listUnsubscribe&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"List-Unsubscribe:"})," ",s.listUnsubscribe]}),j.length>0&&e.jsxs(n,{variant:"subtitle2",children:[e.jsx(n,{component:"span",fontWeight:"bold",children:"Parsed Unsubscribe URIs:"})," ",j.join(", ")]})]})})})})]})}const pe=()=>{const{subscriptions:s,orders:a,unsubscribes:o,reload:l}=ne(),[d,x]=h.useState(0),[u,W]=h.useState(20),[g,y]=h.useState(0),[w,j]=h.useState(10),[U,C]=h.useState(0),[P,S]=h.useState(10),O=h.useMemo(()=>{const c=[...a.filter(T=>!T.labelIds?.includes("SENT"))].sort((T,Q)=>{const X=new Date(T.date).getTime();return new Date(Q.date).getTime()-X}),p=d*u;return c.slice(p,p+u)},[a,d,u]),m=h.useMemo(()=>oe(o),[o]),R=h.useMemo(()=>{const t=g*w;return m.slice(t,t+w)},[m,g,w]),D=h.useMemo(()=>{const t=U*P;return s.slice(t,t+P)},[s,U,P]),b=(t,c)=>{x(c)},N=t=>{W(parseInt(t.target.value,10)),x(0)},q=(t,c)=>{y(c)},H=t=>{j(parseInt(t.target.value,10)),y(0)},G=(t,c)=>{C(c)},J=t=>{S(parseInt(t.target.value,10)),C(0)};return h.useEffect(()=>{},[s.length,a.length,o.length]),e.jsxs(i,{children:[e.jsx(n,{variant:"h4",gutterBottom:!0,children:"Dashboard"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:3},children:[e.jsx(i,{sx:{width:"100%",maxWidth:800},children:e.jsxs(i,{sx:{p:2,border:"1px solid #ddd",borderRadius:1},children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:["Recent Orders ",e.jsx(I,{label:a.length,size:"small"})]}),a.length>0?e.jsxs(e.Fragment,{children:[e.jsx(B,{component:k,elevation:0,sx:{boxShadow:"none",background:"transparent"},children:e.jsx($,{size:"small","aria-label":"collapsible table",children:e.jsx(z,{children:O.map(t=>e.jsx(ae,{order:t},t.id))})})}),e.jsx(E,{component:"div",count:a.length,page:d,onPageChange:b,rowsPerPage:u,onRowsPerPageChange:N,rowsPerPageOptions:[10,20,50],labelRowsPerPage:"Rows per page:",labelDisplayedRows:({from:t,to:c,count:p})=>`${t}-${c} of ${p}`})]}):e.jsx(n,{variant:"body2",color:"text.secondary",children:"No orders found"})]})}),e.jsx(i,{sx:{width:"100%",maxWidth:800},children:e.jsxs(i,{sx:{p:2,border:"1px solid #ddd",borderRadius:1},children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:["Subscriptions ",e.jsx(I,{label:s.length,size:"small"})]}),s.length>0?e.jsxs(e.Fragment,{children:[e.jsx(B,{component:k,elevation:0,sx:{boxShadow:"none",background:"transparent"},children:e.jsx($,{size:"small","aria-label":"collapsible table",children:e.jsx(z,{children:D.map(t=>e.jsx(re,{subscription:t},t.id))})})}),e.jsx(E,{component:"div",count:s.length,page:U,onPageChange:G,rowsPerPage:P,onRowsPerPageChange:J,rowsPerPageOptions:[10,20,50],labelRowsPerPage:"Rows per page:",labelDisplayedRows:({from:t,to:c,count:p})=>`${t}-${c} of ${p}`})]}):e.jsx(n,{variant:"body2",color:"text.secondary",children:"No subscriptions found"})]})}),e.jsx(i,{sx:{width:"100%",maxWidth:800},children:e.jsxs(i,{sx:{p:2,border:"1px solid #ddd",borderRadius:1},children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:["Unsubscribe List ",e.jsx(I,{label:o.length,size:"small"})]}),o.length>0?e.jsxs(e.Fragment,{children:[e.jsx(B,{component:k,elevation:0,sx:{boxShadow:"none",background:"transparent"},children:e.jsxs($,{size:"small","aria-label":"collapsible table",children:[e.jsx(Y,{children:e.jsxs(f,{children:[e.jsx(r,{}),e.jsx(r,{sx:{width:"100%"},children:"Sender"}),e.jsx(r,{sx:{whiteSpace:"nowrap"},children:"Occurrence"}),e.jsx(r,{sx:{whiteSpace:"nowrap"},children:"Unsubscribe"})]})}),e.jsx(z,{children:R.map(t=>e.jsx(le,{sender:t},t.from))})]})}),e.jsx(E,{component:"div",count:m.length,page:g,onPageChange:q,rowsPerPage:w,onRowsPerPageChange:H,rowsPerPageOptions:[10,20,50],labelRowsPerPage:"Rows per page:",labelDisplayedRows:({from:t,to:c,count:p})=>`${t}-${c} of ${p}`})]}):e.jsx(n,{variant:"body2",color:"text.secondary",children:"No high-noise senders found"})]})})]})]})};export{pe as default};
